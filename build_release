#!/bin/bash

set -ex

PRESET=${1:-minSizeRel}

#generic test build and examples
./testit on/linux $PRESET
./clean
#generic builds, need user to implement accessors
./buildit on/cortex-m0 $PRESET
./buildit on/cortex-m3 $PRESET
./buildit on/cortex-m4 $PRESET
./buildit on/cortex-m7 $PRESET
./buildit on/cortex-m23 $PRESET
./buildit on/cortex-m33 $PRESET
./buildit on/cortex-m35p $PRESET
./buildit on/cortex-m52 $PRESET
./buildit on/cortex-m55 $PRESET
./buildit on/cortex-m85 $PRESET
#targeted builds for few specific MCUs
./buildit on/stm32u5 $PRESET
./buildit on/stm32l5 $PRESET

OUT=dist/$PRESET/liblean-ftl
rm -rf $OUT
mkdir -p $OUT
cp LICENSE $OUT
cp -R liblean-ftl/include $OUT
cp -R liblean-ftl/source $OUT
mv build $OUT
git status
git diff package.json
sha256sum package.json
git describe --tags --always --dirty --match "v*" > $OUT/version.txt
cd dist/$PRESET
7z a liblean-ftl-$PRESET.7z liblean-ftl
sha512sum liblean-ftl-$PRESET.7z > liblean-ftl-$PRESET.7z.sha512sum
cd ../..
rm -rf $OUT
mv dist/$PRESET/* dist
rm -rf dist/$PRESET